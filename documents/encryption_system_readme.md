# 游戏存档加密系统

## 概述
为了保护用户游戏存档的安全性和私密性，我们为GameExplorer_V1游戏添加了完整的存档加密功能。这个系统使用现代加密技术保护玩家的游戏进度数据，防止存档被恶意修改或窃取。

## 安全特性

### 1. 数据加密
- **加密算法**: 使用XOR加密算法（可扩展为更强的加密算法）
- **密钥管理**: 支持静态密钥和动态密钥
- **数据完整性**: 使用校验和验证数据完整性
- **文件格式**: 自定义二进制格式，包含魔数标识和版本信息

### 2. 伦理考虑
- **用户隐私**: 保护玩家的游戏进度不被他人窥探
- **数据安全**: 防止存档被恶意修改或破坏
- **透明度**: 用户可以选择启用或禁用加密
- **性能优化**: 加密过程高效，不影响游戏体验

## 技术实现

### 核心组件

#### 1. EncryptionManager (加密管理器)
- **文件位置**: `scripts/EncryptionManager.gd`
- **类型**: 静态工具类
- **功能**: 
  - 数据加密和解密
  - 文件完整性验证
  - 动态密钥生成
  - 加密文件信息获取

#### 2. SaveManager (存档管理器增强)
- **文件位置**: `scripts/SaveManager.gd`
- **新增功能**:
  - 加密模式切换
  - 加密存档保存和读取
  - 兼容性处理（支持新旧存档格式）

#### 3. EncryptionTest (测试套件)
- **文件位置**: `scripts/EncryptionTest.gd`
- **功能**: 
  - 自动化测试加密功能
  - 数据完整性验证
  - 性能测试

### 加密文件格式

```
+------------------+
| 魔数标识 (4字节)  | "GEXP"
+------------------+
| 版本信息 (2字节)  | "1.0" 
+------------------+
| 数据长度 (4字节)  | 加密数据的长度
+------------------+
| 加密数据 (变长)   | XOR加密的JSON数据
+------------------+
| 校验和 (2字节)    | 用于验证数据完整性
+------------------+
```

## 使用指南

### 1. 用户界面
在游戏暂停菜单中，玩家可以：
- 切换加密功能的开启/关闭
- 查看当前存档的加密状态
- 正常进行存档和读档操作

### 2. 加密设置
- **默认状态**: 加密功能默认启用
- **动态密钥**: 基于系统信息生成唯一密钥
- **实时切换**: 可以在游戏中随时切换加密模式

### 3. 兼容性
- **向后兼容**: 支持读取旧的未加密存档
- **格式检测**: 自动检测存档格式并选择相应的读取方式
- **平滑迁移**: 用户可以选择将旧存档迁移到加密格式

## 开发者指南

### 1. 配置加密功能

```gdscript
# 启用加密（默认）
SaveManager.set_encryption_mode(true, true)

# 禁用加密
SaveManager.set_encryption_mode(false, false)

# 仅使用静态密钥
SaveManager.set_encryption_mode(true, false)
```

### 2. 手动加密数据

```gdscript
# 加密字典数据
var game_data = {"level": "forest", "score": 1200}
var encrypted_bytes = EncryptionManager.encrypt_data(game_data)

# 解密数据
var decrypted_data = EncryptionManager.decrypt_data(encrypted_bytes)
```

### 3. 文件完整性检查

```gdscript
# 验证加密文件
var is_valid = EncryptionManager.verify_encrypted_file("user://save.dat")

# 获取文件信息
var file_info = EncryptionManager.get_encrypted_file_info("user://save.dat")
print("文件大小: ", file_info.total_size)
print("有效性: ", file_info.is_valid)
```

## 安全考虑

### 1. 密钥管理
- **静态密钥**: 适合基础保护，防止普通用户修改存档
- **动态密钥**: 基于系统特征生成，提供更好的安全性
- **密钥轮换**: 未来可扩展支持定期更换密钥

### 2. 攻击防护
- **数据篡改**: 校验和机制防止数据被恶意修改
- **格式验证**: 魔数标识确保文件格式正确
- **版本控制**: 支持未来的加密算法升级

### 3. 隐私保护
- **本地存储**: 加密存档仅存储在用户本地
- **无网络传输**: 不会将加密密钥发送到外部服务器
- **用户控制**: 用户完全控制是否使用加密功能

## 性能分析

### 1. 加密性能
- **算法复杂度**: O(n) 线性时间复杂度
- **内存使用**: 临时占用原数据2倍内存
- **速度**: 对于典型游戏存档（<10KB），加密时间<1ms

### 2. 优化策略
- **延迟加载**: 避免在游戏启动时进行加密操作
- **缓存机制**: 可扩展支持解密结果缓存
- **异步处理**: 对于大型存档，可使用后台线程处理

## 测试和验证

### 1. 自动化测试
游戏启动时（仅在开发模式下）会自动运行以下测试：
- 基础加密解密功能
- 空数据处理
- 复杂数据结构
- 不同密钥验证
- 文件完整性检查

### 2. 手动测试
开发者可以调用以下方法进行手动测试：
```gdscript
SaveManager.run_encryption_test_manual()
```

### 3. 调试工具
```gdscript
# 打印加密文件信息
EncryptionTest.print_file_info("user://save_game_encrypted.dat")
```

## 未来扩展

### 1. 高级加密算法
- **AES加密**: 替换XOR为AES-256加密
- **非对称加密**: 支持RSA公钥加密
- **哈希算法**: 使用SHA-256替代简单校验和

### 2. 云存档支持
- **加密云同步**: 加密存档的云端同步
- **多设备支持**: 跨设备的加密存档同步
- **备份恢复**: 加密存档的云端备份

### 3. 用户体验改进
- **加密强度选择**: 让用户选择加密强度
- **批量迁移**: 支持批量转换存档格式
- **加密状态指示**: 更明显的UI指示当前加密状态

## 故障排除

### 常见问题

#### 1. 加密失败
- **症状**: 保存时显示"加密失败"
- **原因**: 数据格式错误或密钥问题
- **解决**: 检查存档数据完整性，重新生成密钥

#### 2. 解密失败
- **症状**: 读档时显示"解密失败"
- **原因**: 文件损坏、密钥不匹配或格式错误
- **解决**: 验证文件完整性，检查加密设置

#### 3. 性能问题
- **症状**: 存档/读档速度明显变慢
- **原因**: 大型存档数据或系统性能限制
- **解决**: 优化存档数据结构，考虑异步处理

### 调试技巧
1. 查看控制台输出获取详细错误信息
2. 使用测试工具验证加密功能
3. 检查文件权限和磁盘空间
4. 验证Autoload配置是否正确

## 技术规范

### 支持的数据类型
- Dictionary (字典)
- Array (数组)  
- String (字符串)
- Int (整数)
- Float (浮点数)
- Bool (布尔值)
- Vector2/Vector3 (向量)

### 文件规范
- **最大文件大小**: 100MB (理论限制)
- **推荐文件大小**: <1MB (性能考虑)
- **文件扩展名**: `.dat` (加密存档)
- **编码格式**: UTF-8 (JSON序列化)

### 系统要求
- **Godot版本**: 4.2+
- **平台支持**: Windows, macOS, Linux
- **依赖项**: 无外部依赖
- **内存要求**: 额外需要存档数据2倍内存 